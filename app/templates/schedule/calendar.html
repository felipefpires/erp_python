{% extends "base.html" %}

{% block title %}Calendário - Agendamentos{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Calendário</h1>
        <div class="btn-group" role="group">
            <a href="{{ url_for('schedule.new_event') }}" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i>
                Novo Evento
            </a>
            <a href="{{ url_for('schedule.new_appointment') }}" class="btn btn-success">
                <i class="fas fa-calendar-plus me-1"></i>
                Novo Agendamento
            </a>
        </div>
    </div>

    <!-- Calendar controls -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary" id="prevMonth">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button type="button" class="btn btn-outline-primary" id="today">Hoje</button>
                        <button type="button" class="btn btn-outline-primary" id="nextMonth">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-4 text-center">
                    <h4 id="currentMonth" class="mb-0"></h4>
                </div>
                <div class="col-md-4 text-end">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-secondary" id="monthView">Mês</button>
                        <button type="button" class="btn btn-outline-secondary" id="weekView">Semana</button>
                        <button type="button" class="btn btn-outline-secondary" id="dayView">Dia</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar legend -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6 class="mb-3">Legenda</h6>
                    <div class="d-flex flex-wrap gap-3">
                        <div class="d-flex align-items-center">
                            <div class="legend-item bg-primary me-2"></div>
                            <span>Eventos</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="legend-item bg-success me-2"></div>
                            <span>Agendamentos</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="legend-item bg-warning me-2"></div>
                            <span>Reuniões</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="legend-item bg-danger me-2"></div>
                            <span>Urgente</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <h6 class="mb-3">Filtros</h6>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="showEvents" checked>
                        <label class="form-check-label" for="showEvents">Eventos</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="showAppointments" checked>
                        <label class="form-check-label" for="showAppointments">Agendamentos</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar container -->
    <div class="card">
        <div class="card-body">
            <div id="calendar"></div>
        </div>
    </div>
</div>

<!-- Event Modal -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalLabel">Detalhes do Evento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="eventModalBody">
                <!-- Event details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" id="editEvent">Editar</button>
                <button type="button" class="btn btn-danger" id="deleteEvent">Excluir</button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Add Modal -->
<div class="modal fade" id="quickAddModal" tabindex="-1" aria-labelledby="quickAddModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quickAddModalLabel">Adicionar Evento Rápido</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="quickAddForm">
                    <div class="mb-3">
                        <label for="eventType" class="form-label">Tipo</label>
                        <select class="form-select" id="eventType" name="eventType" required>
                            <option value="event">Evento</option>
                            <option value="appointment">Agendamento</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="eventTitle" class="form-label">Título</label>
                        <input type="text" class="form-control" id="eventTitle" name="eventTitle" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="eventDate" class="form-label">Data</label>
                                <input type="date" class="form-control" id="eventDate" name="eventDate" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="eventTime" class="form-label">Hora</label>
                                <input type="time" class="form-control" id="eventTime" name="eventTime" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="eventDuration" class="form-label">Duração (minutos)</label>
                        <input type="number" class="form-control" id="eventDuration" name="eventDuration" value="60" min="15" step="15">
                    </div>
                    <div class="mb-3">
                        <label for="eventDescription" class="form-label">Descrição</label>
                        <textarea class="form-control" id="eventDescription" name="eventDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="saveQuickEvent">Salvar</button>
            </div>
        </div>
    </div>
</div>

<style>
.legend-item {
    width: 20px;
    height: 20px;
    border-radius: 3px;
}

#calendar {
    min-height: 600px;
}

.fc-event {
    cursor: pointer;
}

.fc-event:hover {
    opacity: 0.8;
}

.fc-daygrid-day:hover {
    background-color: rgba(0,0,0,0.05);
}

.fc-toolbar-title {
    font-size: 1.5rem !important;
}

.fc-button {
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
}

.fc-button:hover {
    background-color: #0b5ed7 !important;
    border-color: #0a58ca !important;
}

.fc-button:focus {
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
}

.fc-day-today {
    background-color: rgba(13, 110, 253, 0.1) !important;
}
</style>

<!-- FullCalendar CSS and JS -->
<link href='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.8/main.min.css' rel='stylesheet' />
<link href='https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.8/main.min.css' rel='stylesheet' />
<link href='https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.8/main.min.css' rel='stylesheet' />
<link href='https://cdn.jsdelivr.net/npm/@fullcalendar/list@6.1.8/main.min.css' rel='stylesheet' />

<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.8/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.8/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.8/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/list@6.1.8/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.8/main.min.js'></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let calendar;
    let currentDate = new Date();
    let selectedEvent = null;

    // Initialize calendar
    function initializeCalendar() {
        const calendarEl = document.getElementById('calendar');
        
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'pt-br',
            headerToolbar: false, // We'll use custom header
            height: 'auto',
            selectable: true,
            editable: true,
            eventClick: function(info) {
                showEventDetails(info.event);
            },
            select: function(info) {
                showQuickAddModal(info.startStr);
            },
            eventDrop: function(info) {
                updateEventDate(info.event);
            },
            eventResize: function(info) {
                updateEventDuration(info.event);
            },
            events: function(info, successCallback, failureCallback) {
                loadEvents(info.start, info.end, successCallback);
            },
            eventColor: function(arg) {
                if (arg.event.extendedProps.type === 'appointment') {
                    return '#198754'; // Green for appointments
                } else if (arg.event.extendedProps.priority === 'high') {
                    return '#dc3545'; // Red for high priority
                } else if (arg.event.extendedProps.type === 'meeting') {
                    return '#ffc107'; // Yellow for meetings
                }
                return '#0d6efd'; // Blue for regular events
            }
        });

        calendar.render();
        updateCalendarHeader();
    }

    // Load events from API
    function loadEvents(start, end, callback) {
        fetch(`/schedule/api/events?start=${start.toISOString()}&end=${end.toISOString()}`)
            .then(response => response.json())
            .then(data => {
                const events = data.events.map(event => ({
                    id: event.id,
                    title: event.title,
                    start: event.start_date,
                    end: event.end_date,
                    type: event.type,
                    priority: event.priority,
                    description: event.description,
                    location: event.location,
                    customer: event.customer
                }));
                callback(events);
            })
            .catch(error => {
                console.error('Error loading events:', error);
                callback([]);
            });
    }

    // Update calendar header
    function updateCalendarHeader() {
        const monthNames = [
            'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
        ];
        const currentView = calendar.view;
        const currentDate = currentView.currentStart;
        const month = monthNames[currentDate.getMonth()];
        const year = currentDate.getFullYear();
        
        document.getElementById('currentMonth').textContent = `${month} ${year}`;
    }

    // Show event details modal
    function showEventDetails(event) {
        selectedEvent = event;
        
        const modalBody = document.getElementById('eventModalBody');
        modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-8">
                    <h5>${event.title}</h5>
                    <p class="text-muted">${event.extendedProps.description || 'Sem descrição'}</p>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Data:</strong><br>
                            ${new Date(event.start).toLocaleDateString('pt-BR')}
                        </div>
                        <div class="col-md-6">
                            <strong>Hora:</strong><br>
                            ${new Date(event.start).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}
                        </div>
                    </div>
                    
                    ${event.extendedProps.location ? `
                    <div class="mb-3">
                        <strong>Local:</strong><br>
                        ${event.extendedProps.location}
                    </div>
                    ` : ''}
                    
                    ${event.extendedProps.customer ? `
                    <div class="mb-3">
                        <strong>Cliente:</strong><br>
                        ${event.extendedProps.customer.name}
                    </div>
                    ` : ''}
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h6>Informações</h6>
                            <p><strong>Tipo:</strong> ${event.extendedProps.type || 'Evento'}</p>
                            <p><strong>Prioridade:</strong> ${event.extendedProps.priority || 'Normal'}</p>
                            <p><strong>Duração:</strong> ${getEventDuration(event)}</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        const modal = new bootstrap.Modal(document.getElementById('eventModal'));
        modal.show();
    }

    // Get event duration
    function getEventDuration(event) {
        const start = new Date(event.start);
        const end = new Date(event.end);
        const diffMs = end - start;
        const diffMins = Math.round(diffMs / 60000);
        
        if (diffMins < 60) {
            return `${diffMins} minutos`;
        } else {
            const hours = Math.floor(diffMins / 60);
            const mins = diffMins % 60;
            return `${hours}h ${mins}min`;
        }
    }

    // Show quick add modal
    function showQuickAddModal(date) {
        document.getElementById('eventDate').value = date;
        document.getElementById('eventTime').value = '09:00';
        
        const modal = new bootstrap.Modal(document.getElementById('quickAddModal'));
        modal.show();
    }

    // Save quick event
    document.getElementById('saveQuickEvent').addEventListener('click', function() {
        const form = document.getElementById('quickAddForm');
        const formData = new FormData(form);
        
        const eventData = {
            title: formData.get('eventTitle'),
            description: formData.get('eventDescription'),
            start_date: formData.get('eventDate') + 'T' + formData.get('eventTime'),
            duration: parseInt(formData.get('eventDuration')),
            type: formData.get('eventType')
        };
        
        fetch('/schedule/api/events', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(eventData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                calendar.refetchEvents();
                bootstrap.Modal.getInstance(document.getElementById('quickAddModal')).hide();
                form.reset();
            } else {
                alert('Erro ao criar evento: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erro ao criar evento');
        });
    });

    // Calendar navigation
    document.getElementById('prevMonth').addEventListener('click', function() {
        calendar.prev();
        updateCalendarHeader();
    });

    document.getElementById('nextMonth').addEventListener('click', function() {
        calendar.next();
        updateCalendarHeader();
    });

    document.getElementById('today').addEventListener('click', function() {
        calendar.today();
        updateCalendarHeader();
    });

    // View changes
    document.getElementById('monthView').addEventListener('click', function() {
        calendar.changeView('dayGridMonth');
        updateCalendarHeader();
    });

    document.getElementById('weekView').addEventListener('click', function() {
        calendar.changeView('timeGridWeek');
        updateCalendarHeader();
    });

    document.getElementById('dayView').addEventListener('click', function() {
        calendar.changeView('timeGridDay');
        updateCalendarHeader();
    });

    // Event modal actions
    document.getElementById('editEvent').addEventListener('click', function() {
        if (selectedEvent) {
            const eventType = selectedEvent.extendedProps.type;
            const url = eventType === 'appointment' 
                ? `/schedule/appointments/${selectedEvent.id}/edit`
                : `/schedule/events/${selectedEvent.id}/edit`;
            window.location.href = url;
        }
    });

    document.getElementById('deleteEvent').addEventListener('click', function() {
        if (selectedEvent && confirm('Tem certeza que deseja excluir este evento?')) {
            const eventType = selectedEvent.extendedProps.type;
            const url = eventType === 'appointment' 
                ? `/schedule/appointments/${selectedEvent.id}/delete`
                : `/schedule/events/${selectedEvent.id}/delete`;
            
            fetch(url, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    calendar.refetchEvents();
                    bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
                } else {
                    alert('Erro ao excluir evento: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erro ao excluir evento');
            });
        }
    });

    // Initialize the calendar
    initializeCalendar();
});
</script>
{% endblock %}


